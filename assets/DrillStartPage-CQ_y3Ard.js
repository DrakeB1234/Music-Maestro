import{r as m,j as e,u as R}from"./react-DCaQfIlb.js";import{u as r,G as q,a as H,b as J,c as S,N as G,B as v,S as Q,F as Z,P as A,d as B,M as tt,T as et,A as nt,e as at,f as st,g as rt,C as ot,h as it,i as ct,j as lt,k as ut,l as dt,m as L}from"./index-CGnPWOhB.js";import"./webmidi-DLahG6sQ.js";import"./vendor-p4PpBVHW.js";import"./vexflow-B_RgdgAq.js";const pt="_StaffContainer_1fdyi_1",ft={StaffContainer:pt};function mt(){const o=r(t=>t.currentNote),a=r(t=>t.playedStatusNote),i=m.useRef(null),s=m.useRef(null);return m.useEffect(()=>{const t=r.getState().drillOptions;if(!(!i.current||!t))if(s.current)o&&s.current.drawNote(o);else{const c=t.octaveRange?.maxOctave,d=t.octaveRange?.minOctave,l=c?q(c,t.clef||"treble"):0,C=d?H(d,t.clef||"treble"):0,f=new J(i.current,t.clef,void 0,void 0,l,C);if(!f)return;s.current=f}},[o]),m.useEffect(()=>{const t=r.getState().playedNote,c=r.getState().playedNoteStatus,d=r.getState().playedStatusNote;!d||!t||!o||c==="correct"||s.current?.drawWrongNote(o,d)},[a]),e.jsx("div",{className:ft.StaffContainer,ref:i})}const Nt="_TopBarWrapper_1x8ji_1",ht="_StatusBarContainer_1x8ji_33",Ct="_StatusBarError_1x8ji_41",St="_StatusBarSuccess_1x8ji_49",xt="_CurrentNoteContainer_1x8ji_59",vt="_ButtonInputWrapper_1x8ji_103",yt="_PianoInput_1x8ji_119",_t="_MIDIInput_1x8ji_129",jt="_MIDIInputDisconnectedContainer_1x8ji_139",N={TopBarWrapper:Nt,StatusBarContainer:ht,StatusBarError:Ct,StatusBarSuccess:St,CurrentNoteContainer:xt,ButtonInputWrapper:vt,PianoInput:yt,MIDIInput:_t,MIDIInputDisconnectedContainer:jt},Bt="_NoteButtonInputWrapper_ys8tc_1",It="_AccidentalButtonsContainer_ys8tc_15",Dt="_NoteButtonsContainer_ys8tc_25",P={NoteButtonInputWrapper:Bt,AccidentalButtonsContainer:It,NoteButtonsContainer:Dt};function gt(){const o=m.useRef(null),a=S(t=>t.triggerButtonInput),i=t=>{const c={name:t,accidental:o.current,octave:null};a(c)},s=t=>{o.current=t};return e.jsxs("div",{className:P.NoteButtonInputWrapper,children:[e.jsx(At,{onAccidentalSet:s}),e.jsx("div",{className:P.NoteButtonsContainer,children:G.map(t=>e.jsx(v,{onClick:()=>i(t),variant:"outlined",size:"large",text:t},t))})]})}function At({onAccidentalSet:o}){const[a,i]=m.useState(null),s=t=>{if(t===a){i(null),o(null);return}o(t),i(t)};return e.jsxs("div",{className:P.AccidentalButtonsContainer,children:[e.jsx(v,{active:a==="#",onClick:()=>s("#"),variant:"outlined",icon:e.jsx(Q,{})}),e.jsx(v,{active:a==="b",onClick:()=>s("b"),variant:"outlined",icon:e.jsx(Z,{})})]})}const w=[{note:{name:"C",octave:1},url:"/piano_samples/C1.mp3"},{note:{name:"C",octave:2},url:"/piano_samples/C2.mp3"},{note:{name:"C",octave:3},url:"/piano_samples/C3.mp3"},{note:{name:"C",octave:4},url:"/piano_samples/C4.mp3"},{note:{name:"C",octave:5},url:"/piano_samples/C5.mp3"},{note:{name:"C",octave:6},url:"/piano_samples/C6.mp3"},{note:{name:"C",octave:7},url:"/piano_samples/C7.mp3"}],E=.5;class I{static audioContext;static pianoBuffers={};static masterGain;static audioPrefs={volume:50,playbackEnabled:!1};static playbackNoteLimit={min:{name:"C",octave:1},max:{name:"C",octave:8}};static init(){this.audioContext||(this.audioContext=new AudioContext),this.masterGain||(this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=E,this.masterGain.connect(this.audioContext.destination)),this.setVolume(this.audioPrefs.volume)}static async loadSample(a,i){if(this.pianoBuffers[a])return;const t=await(await fetch(i)).arrayBuffer(),c=await this.audioContext.decodeAudioData(t);this.pianoBuffers[a]=c}static async loadAllSamples(){this.init();const a=w.map(async i=>{await this.loadSample(A(i.note),i.url)});await Promise.all(a)}static determineSample(a){const s=w.map(t=>{const c=Math.abs(a-B(t.note));return{sample:t,semitoneOffset:a-B(t.note),absOffset:c}}).reduce((t,c)=>c.absOffset<t.absOffset?c:t);return{sample:A(s.sample.note),semitoneOffset:s.semitoneOffset}}static playNote(a,i=5){if(this.audioContext.state!=="running"&&this.audioContext.resume(),!this.audioPrefs.playbackEnabled)return;this.audioPrefs.volume&&this.setVolume(this.audioPrefs.volume);const s=B(a),t=B(this.playbackNoteLimit.min),c=B(this.playbackNoteLimit.max);if(s<t||s>c)return;const{sample:d,semitoneOffset:l}=this.determineSample(s),C=this.pianoBuffers[d];if(!C)return;const f=this.audioContext.createBufferSource();f.buffer=C,f.playbackRate.value=Math.pow(2,l/12);const h=this.audioContext.createGain();h.gain.setValueAtTime(1,this.audioContext.currentTime),h.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+i),f.connect(h),h.connect(this.masterGain),f.start(),f.stop(this.audioContext.currentTime+i),f.onended=()=>{f.disconnect(),h.disconnect()}}static playChord(a,i=5){!a||a.length===0||a.forEach(s=>{this.playNote(s,i)})}static setVolume(a){this.masterGain.gain.value=Math.max(0,E*(a/100))}static applyPreferences(a){I.audioPrefs=a}}const Pt="_ModalContentContainer_30uwr_1",Mt="_ModalActionButtonsContainer_30uwr_17",bt="_ContentWrapper_30uwr_31",Tt="_AccuracyContainer_30uwr_45",Ot="_ScoreContainer_30uwr_47",x={ModalContentContainer:Pt,ModalActionButtonsContainer:Mt,ContentWrapper:bt,AccuracyContainer:Tt,ScoreContainer:Ot};function Wt({drillScore:o,correctNotesPlayed:a,totalNotesPlayed:i,handleDrillExit:s,handleDrillTryAgain:t}){const c=Math.ceil(a/i*100);return e.jsxs(tt,{headerText:"Drill Over!",icon:e.jsx(et,{}),overrideExitButtonPressed:s,children:[e.jsxs("div",{className:x.ModalContentContainer,children:[e.jsxs("div",{className:x.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Your Score"}),e.jsx("div",{className:x.ScoreContainer,children:e.jsx("p",{className:"large-heading",children:o})})]}),e.jsxs("div",{className:x.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Accuracy"}),e.jsxs("div",{className:x.AccuracyContainer,children:[e.jsx("p",{className:"heading-secondary",children:`Correct: ${a}/${i}`}),e.jsxs("p",{className:"heading-secondary",children:[isNaN(c)?0:c,"%"]})]})]})]}),e.jsxs("div",{className:x.ModalActionButtonsContainer,children:[e.jsx(v,{text:"Close",variant:"outlined",fullWidth:!0,onClick:s}),e.jsx(v,{text:"Try Again",fullWidth:!0,onClick:t})]})]})}const kt="_PianoRollWrapper_1w151_1",wt="_WhiteKey_1w151_15",Et="_BlackKey_1w151_31",g={PianoRollWrapper:kt,WhiteKey:wt,BlackKey:Et},Rt=[15,36,76,96,116];function Gt(){const o=S(s=>s.triggerButtonInput);function a(s){const t=s.match(/^([A-G])([#b]?)/);return t?{noteName:t[1],noteAccidental:t[2]}:{letter:s,accidental:""}}const i=s=>{const c=s.target.getAttribute("id");if(c){const{noteName:d,noteAccidental:l}=a(c);if(!d)return;o({name:d,accidental:l||null,octave:null})}};return e.jsxs("svg",{width:"140",height:"80",fill:"none",viewBox:"0 0 140 80",onClick:i,className:g.PianoRollWrapper,children:[G.map((s,t)=>e.jsxs("g",{className:g.WhiteKey,id:s,children:[e.jsx("rect",{id:s,width:20,height:80,fill:"var(--color-surface-light-1)",x:20*t}),e.jsx("line",{x1:t*20+1,x2:t*20+1,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:0,id:s}),e.jsx("line",{x1:t*20+20,x2:t*20+20,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:.5,id:s})]},s)),nt.map((s,t)=>e.jsx("g",{className:g.BlackKey,id:s,children:e.jsx("rect",{id:s,width:9,height:70,fill:"#282828",stroke:"#000",strokeWidth:3,x:Rt[t],y:-27})},s))]})}const Lt=150;function $t(){const o=r(n=>n.setCurrentNote),a=r(n=>n.setPlayedNote),i=r(n=>n.setPlayedNoteStatus),s=r(n=>n.setTimeSinceLastCorrectNote),t=r(n=>n.setDrillScore),c=r(n=>n.setIsDrillStarted),d=r(n=>n.resetDrillOptions),l=r(n=>n.setDrillOptions),C=S(n=>n.setButtonInputListener),f=S(n=>n.addMidiListener),h=S(n=>n.removeMidiListener),{addResult:$}=at(),y=m.useRef(0),_=m.useRef(0),{openModal:K,setPreventClose:D,closeModal:M}=st(),V=R();function b(){const n=r.getState().drillOptions;if(!n)return;const p=r.getState().currentNote;let u=null;n.inclusiveNotes&&n.inclusiveNotes?.length>1?u=it(n.inclusiveNotes,p||null):n.octaveRange&&(u=ct(p||null,n.octaveRange,n.allowedAccidentals)),u&&o(u)}function F(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(a(n),u&&lt(n,u)){n.octave=u?.octave||null,W(u);return}n.octave=u?.octave||null,O(n)}function T(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(a(n),u&&ut(n,u)){W(n);return}O(n)}function O(n){y.current+=1,i("wrong",n)}function W(n){b(),y.current+=1,_.current+=1,i("correct",n),U(),I.playNote(n)}function U(){const n=r.getState().timeSinceLastCorrectNote,p=Date.now(),u=p-n;s(p);let j=Math.round(Lt*Math.exp(-4e-4*u));j=Math.max(j,0),t(j)}function z(){const n=r.getState().drillScore,p=r.getState().drillOptions,u=p?.timer?p.timer:1,j=Math.round(_.current/u*60);p?.drillId&&$({id:p.drillId,correctNotes:_.current,totalNotes:y.current,score:n,correctNotesPerMinute:j}),c(!1),Y()}function k(){D(!1),M(),d(),V("/")}function X(){const n=r.getState().drillOptions;_.current=0,y.current=0,t(0),n&&l({...n}),D(!1),M()}const Y=()=>{const n=r.getState().drillScore;D(!0),K(e.jsx(Wt,{drillScore:n,correctNotesPlayed:_.current,totalNotesPlayed:y.current,handleDrillExit:k,handleDrillTryAgain:X}))};return m.useEffect(()=>{C(n=>F(n))},[C]),m.useEffect(()=>(f(T),()=>{h(T)}),[f,h]),m.useEffect(()=>{b()},[]),e.jsxs("div",{className:N.NoteDrillWrapper,children:[e.jsx(rt,{onBack:k}),e.jsxs(ot,{children:[e.jsxs("div",{className:N.TopBarWrapper,children:[e.jsx(zt,{handleTimeOut:z}),e.jsx(Ut,{})]}),e.jsx(Vt,{}),e.jsx(mt,{}),e.jsx(Ft,{}),e.jsx(Kt,{})]})]})}function Kt(){const{prefs:o}=L(),a=o.inputType,{connectMidiDevice:i}=S(),s=S(t=>t.isMidiDeviceConnected);return a==="buttons"?e.jsx("div",{className:`${N.ButtonInputWrapper}`,children:e.jsx(gt,{})}):a==="piano"?e.jsx("div",{className:`${N.ButtonInputWrapper} ${N.PianoInput}`,children:e.jsx(Gt,{})}):e.jsxs("div",{className:`${N.ButtonInputWrapper} ${N.MIDIInput}`,children:[s&&e.jsx("p",{children:"MIDI Device Connected"}),!s&&e.jsxs("div",{className:N.MIDIInputDisconnectedContainer,children:[e.jsx("p",{children:"MIDI Device Disconnected"}),e.jsx(v,{text:"Connect",variant:"outlined",onClick:i})]})]})}function Vt(){const o=r(i=>i.playedNoteStatus),a=o=="correct"?N.StatusBarSuccess:o=="wrong"?N.StatusBarError:"";return e.jsx("div",{className:`${N.StatusBarContainer} ${a}`})}function Ft(){const o=r(a=>a.currentNote);return e.jsx("p",{className:N.CurrentNoteContainer,children:o&&A(o)})}function Ut(){const o=r(a=>a.drillScore);return e.jsx("p",{children:o})}function zt({handleTimeOut:o}){const a=r(t=>t.drillTime),i=r(t=>t.isDrillStarted),s=r(t=>t.decrementDrillTime);return m.useEffect(()=>{if(!i)return;if(a<1){o();return}const t=setInterval(()=>{s()},1e3);return()=>{clearInterval(t)}},[a]),e.jsx("p",{children:dt(a)})}const Xt="_DrillStartWrapper_1lv0v_1",Yt={DrillStartWrapper:Xt};function te(){const{prefs:o}=L(),a=r(l=>l.drillOptions),i=r(l=>l.setDrillTime),s=r(l=>l.setIsDrillStarted),t=r(l=>l.resetDrill),c=r(l=>l.setTimeSinceLastCorrectNote),d=R();if(m.useEffect(()=>{if(!a){d("/");return}t(),i(a.timer?a.timer:10),s(!0),c(Date.now()),o.midiPlaybackEnabled&&o.midiPlaybackEnabled&&o.midiPlaybackVolume&&(I.applyPreferences({playbackEnabled:o.midiPlaybackEnabled,volume:o.midiPlaybackVolume}),I.loadAllSamples())},[a]),!!a)return e.jsx("div",{className:Yt.DrillStartWrapper,children:e.jsx("div",{className:"size-wrapper",children:e.jsx($t,{})})})}export{te as default};
