import{r as m,j as e,u as L}from"./react-DCaQfIlb.js";import{u as r,G as H,a as J,b as Q,c as S,N as $,B as v,S as Z,F as tt,P,d as B,M as et,T as nt,A as st,e as at,f as b,g as rt,h as ot,C as it,i as ct,j as lt,k as ut,l as dt,m as pt}from"./index-DPfKvhql.js";import"./webmidi-DLahG6sQ.js";import"./vendor-p4PpBVHW.js";import"./vexflow-B_RgdgAq.js";const ft="_StaffContainer_1fdyi_1",mt={StaffContainer:ft};function Nt(){const i=r(t=>t.currentNote),s=r(t=>t.playedStatusNote),o=m.useRef(null),a=m.useRef(null);return m.useEffect(()=>{const t=r.getState().drillOptions;if(!(!o.current||!t))if(a.current)i&&a.current.drawNote(i);else{const c=t.octaveRange?.maxOctave,d=t.octaveRange?.minOctave,l=c?H(c,t.clef||"treble"):0,C=d?J(d,t.clef||"treble"):0,f=new Q(o.current,t.clef,void 0,void 0,l,C);if(!f)return;a.current=f}},[i]),m.useEffect(()=>{const t=r.getState().playedNote,c=r.getState().playedNoteStatus,d=r.getState().playedStatusNote;!d||!t||!i||c==="correct"||a.current?.drawWrongNote(i,d)},[s]),e.jsx("div",{className:mt.StaffContainer,ref:o})}const ht="_TopBarWrapper_1x8ji_1",Ct="_StatusBarContainer_1x8ji_33",St="_StatusBarError_1x8ji_41",xt="_StatusBarSuccess_1x8ji_49",vt="_CurrentNoteContainer_1x8ji_59",_t="_ButtonInputWrapper_1x8ji_103",yt="_PianoInput_1x8ji_119",jt="_MIDIInput_1x8ji_129",Bt="_MIDIInputDisconnectedContainer_1x8ji_139",N={TopBarWrapper:ht,StatusBarContainer:Ct,StatusBarError:St,StatusBarSuccess:xt,CurrentNoteContainer:vt,ButtonInputWrapper:_t,PianoInput:yt,MIDIInput:jt,MIDIInputDisconnectedContainer:Bt},It="_NoteButtonInputWrapper_ys8tc_1",Dt="_AccidentalButtonsContainer_ys8tc_15",gt="_NoteButtonsContainer_ys8tc_25",M={NoteButtonInputWrapper:It,AccidentalButtonsContainer:Dt,NoteButtonsContainer:gt};function At(){const i=m.useRef(null),s=S(t=>t.triggerButtonInput),o=t=>{const c={name:t,accidental:i.current,octave:null};s(c)},a=t=>{i.current=t};return e.jsxs("div",{className:M.NoteButtonInputWrapper,children:[e.jsx(Pt,{onAccidentalSet:a}),e.jsx("div",{className:M.NoteButtonsContainer,children:$.map(t=>e.jsx(v,{onClick:()=>o(t),variant:"outlined",size:"large",text:t},t))})]})}function Pt({onAccidentalSet:i}){const[s,o]=m.useState(null),a=t=>{if(t===s){o(null),i(null);return}i(t),o(t)};return e.jsxs("div",{className:M.AccidentalButtonsContainer,children:[e.jsx(v,{active:s==="#",onClick:()=>a("#"),variant:"outlined",icon:e.jsx(Z,{})}),e.jsx(v,{active:s==="b",onClick:()=>a("b"),variant:"outlined",icon:e.jsx(tt,{})})]})}const R=[{note:{name:"C",octave:1},url:"/piano_samples/C1.mp3"},{note:{name:"C",octave:2},url:"/piano_samples/C2.mp3"},{note:{name:"C",octave:3},url:"/piano_samples/C3.mp3"},{note:{name:"C",octave:4},url:"/piano_samples/C4.mp3"},{note:{name:"C",octave:5},url:"/piano_samples/C5.mp3"},{note:{name:"C",octave:6},url:"/piano_samples/C6.mp3"},{note:{name:"C",octave:7},url:"/piano_samples/C7.mp3"}],G=.5;class I{static audioContext;static pianoBuffers={};static masterGain;static audioPrefs={volume:50,playbackEnabled:!1};static playbackNoteLimit={min:{name:"C",octave:1},max:{name:"C",octave:8}};static init(){this.audioContext||(this.audioContext=new AudioContext),this.masterGain||(this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=G,this.masterGain.connect(this.audioContext.destination)),this.setVolume(this.audioPrefs.volume)}static async loadSample(s,o){if(this.pianoBuffers[s])return;const t=await(await fetch(o)).arrayBuffer(),c=await this.audioContext.decodeAudioData(t);this.pianoBuffers[s]=c}static async loadAllSamples(){this.init();const s=R.map(async o=>{await this.loadSample(P(o.note),o.url)});await Promise.all(s)}static determineSample(s){const a=R.map(t=>{const c=Math.abs(s-B(t.note));return{sample:t,semitoneOffset:s-B(t.note),absOffset:c}}).reduce((t,c)=>c.absOffset<t.absOffset?c:t);return{sample:P(a.sample.note),semitoneOffset:a.semitoneOffset}}static playNote(s,o=5){if(this.audioContext.state!=="running"&&this.audioContext.resume(),!this.audioPrefs.playbackEnabled)return;this.audioPrefs.volume&&this.setVolume(this.audioPrefs.volume);const a=B(s),t=B(this.playbackNoteLimit.min),c=B(this.playbackNoteLimit.max);if(a<t||a>c)return;const{sample:d,semitoneOffset:l}=this.determineSample(a),C=this.pianoBuffers[d];if(!C)return;const f=this.audioContext.createBufferSource();f.buffer=C,f.playbackRate.value=Math.pow(2,l/12);const h=this.audioContext.createGain();h.gain.setValueAtTime(1,this.audioContext.currentTime),h.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+o),f.connect(h),h.connect(this.masterGain),f.start(),f.stop(this.audioContext.currentTime+o),f.onended=()=>{f.disconnect(),h.disconnect()}}static setVolume(s){this.masterGain.gain.value=Math.max(0,G*(s/100))}static applyPreferences(s){I.audioPrefs=s}}const Mt="_ModalContentContainer_30uwr_1",bt="_ModalActionButtonsContainer_30uwr_17",Tt="_ContentWrapper_30uwr_31",Ot="_AccuracyContainer_30uwr_45",Wt="_ScoreContainer_30uwr_47",x={ModalContentContainer:Mt,ModalActionButtonsContainer:bt,ContentWrapper:Tt,AccuracyContainer:Ot,ScoreContainer:Wt};function kt({drillScore:i,correctNotesPlayed:s,totalNotesPlayed:o,handleDrillExit:a,handleDrillTryAgain:t}){const c=Math.ceil(s/o*100);return e.jsxs(et,{headerText:"Drill Over!",icon:e.jsx(nt,{}),overrideExitButtonPressed:a,children:[e.jsxs("div",{className:x.ModalContentContainer,children:[e.jsxs("div",{className:x.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Your Score"}),e.jsx("div",{className:x.ScoreContainer,children:e.jsx("p",{className:"large-heading",children:i})})]}),e.jsxs("div",{className:x.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Accuracy"}),e.jsxs("div",{className:x.AccuracyContainer,children:[e.jsx("p",{className:"heading-secondary",children:`Correct: ${s}/${o}`}),e.jsxs("p",{className:"heading-secondary",children:[isNaN(c)?0:c,"%"]})]})]})]}),e.jsxs("div",{className:x.ModalActionButtonsContainer,children:[e.jsx(v,{text:"Close",variant:"outlined",fullWidth:!0,onClick:a}),e.jsx(v,{text:"Try Again",fullWidth:!0,onClick:t})]})]})}const wt="_PianoRollWrapper_1w151_1",Et="_WhiteKey_1w151_15",Rt="_BlackKey_1w151_31",A={PianoRollWrapper:wt,WhiteKey:Et,BlackKey:Rt},Gt=[15,36,76,96,116];function Lt(){const i=S(a=>a.triggerButtonInput);function s(a){const t=a.match(/^([A-G])([#b]?)/);return t?{noteName:t[1],noteAccidental:t[2]}:{letter:a,accidental:""}}const o=a=>{const c=a.target.getAttribute("id");if(c){const{noteName:d,noteAccidental:l}=s(c);if(!d)return;i({name:d,accidental:l||null,octave:null})}};return e.jsxs("svg",{width:"140",height:"80",fill:"none",viewBox:"0 0 140 80",onClick:o,className:A.PianoRollWrapper,children:[$.map((a,t)=>e.jsxs("g",{className:A.WhiteKey,id:a,children:[e.jsx("rect",{id:a,width:20,height:80,fill:"var(--color-surface-light-1)",x:20*t}),e.jsx("line",{x1:t*20+1,x2:t*20+1,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:0,id:a}),e.jsx("line",{x1:t*20+20,x2:t*20+20,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:.5,id:a})]},a)),st.map((a,t)=>e.jsx("g",{className:A.BlackKey,id:a,children:e.jsx("rect",{id:a,width:9,height:70,fill:"#282828",stroke:"#000",strokeWidth:3,x:Gt[t],y:-27})},a))]})}const $t=150;function Kt(){const i=r(n=>n.setCurrentNote),s=r(n=>n.setPlayedNote),o=r(n=>n.setPlayedNoteStatus),a=r(n=>n.setTimeSinceLastCorrectNote),t=r(n=>n.setDrillScore),c=r(n=>n.setIsDrillStarted),d=r(n=>n.resetDrillOptions),l=r(n=>n.setDrillOptions),C=S(n=>n.setButtonInputListener),f=S(n=>n.addMidiListener),h=S(n=>n.removeMidiListener),{addResult:K}=at(),{prefs:D}=b(),_=m.useRef(0),y=m.useRef(0),{openModal:V,setPreventClose:g,closeModal:T}=rt(),F=L();function O(){const n=r.getState().drillOptions;if(!n)return;const p=r.getState().currentNote;let u=null;n.inclusiveNotes&&n.inclusiveNotes?.length>1?u=ct(n.inclusiveNotes,p||null):n.octaveRange&&(u=lt(p||null,n.octaveRange,n.allowedAccidentals)),u&&i(u)}function U(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(s(n),u&&ut(n,u)){n.octave=u?.octave||null,w(u);return}n.octave=u?.octave||null,k(n)}function W(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(s(n),u&&dt(n,u)){w(n);return}k(n)}function k(n){_.current+=1,o("wrong",n)}function w(n){O(),_.current+=1,y.current+=1,o("correct",n),z(),I.playNote(n)}function z(){const n=r.getState().timeSinceLastCorrectNote,p=Date.now(),u=p-n;a(p);let j=Math.round($t*Math.exp(-4e-4*u));j=Math.max(j,0),t(j)}function X(){const n=r.getState().drillScore,p=r.getState().drillOptions,u=p?.timer?p.timer:1,j=Math.round(y.current/u*60);p?.drillId&&K({id:p.drillId,correctNotes:y.current,totalNotes:_.current,score:n,correctNotesPerMinute:j}),c(!1),q()}function E(){g(!1),T(),d(),F("/")}function Y(){const n=r.getState().drillOptions;y.current=0,_.current=0,t(0),n&&l({...n}),g(!1),T()}const q=()=>{const n=r.getState().drillScore;g(!0),V(e.jsx(kt,{drillScore:n,correctNotesPlayed:y.current,totalNotesPlayed:_.current,handleDrillExit:E,handleDrillTryAgain:Y}))};return m.useEffect(()=>{C(n=>U(n))},[C]),m.useEffect(()=>(f(W),()=>{h(W)}),[f,h]),m.useEffect(()=>{O(),D.midiPlaybackEnabled&&D.midiPlaybackVolume&&I.applyPreferences({playbackEnabled:D.midiPlaybackEnabled,volume:D.midiPlaybackVolume})},[]),e.jsxs("div",{className:N.NoteDrillWrapper,children:[e.jsx(ot,{onBack:E}),e.jsxs(it,{children:[e.jsxs("div",{className:N.TopBarWrapper,children:[e.jsx(Xt,{handleTimeOut:X}),e.jsx(zt,{})]}),e.jsx(Ft,{}),e.jsx(Nt,{}),e.jsx(Ut,{}),e.jsx(Vt,{})]})]})}function Vt(){const{prefs:i}=b(),s=i.inputType,{connectMidiDevice:o}=S(),a=S(t=>t.isMidiDeviceConnected);return s==="buttons"?e.jsx("div",{className:`${N.ButtonInputWrapper}`,children:e.jsx(At,{})}):s==="piano"?e.jsx("div",{className:`${N.ButtonInputWrapper} ${N.PianoInput}`,children:e.jsx(Lt,{})}):e.jsxs("div",{className:`${N.ButtonInputWrapper} ${N.MIDIInput}`,children:[a&&e.jsx("p",{children:"MIDI Device Connected"}),!a&&e.jsxs("div",{className:N.MIDIInputDisconnectedContainer,children:[e.jsx("p",{children:"MIDI Device Disconnected"}),e.jsx(v,{text:"Connect",variant:"outlined",onClick:o})]})]})}function Ft(){const i=r(o=>o.playedNoteStatus),s=i=="correct"?N.StatusBarSuccess:i=="wrong"?N.StatusBarError:"";return e.jsx("div",{className:`${N.StatusBarContainer} ${s}`})}function Ut(){const i=r(s=>s.currentNote);return e.jsx("p",{className:N.CurrentNoteContainer,children:i&&P(i)})}function zt(){const i=r(s=>s.drillScore);return e.jsx("p",{children:i})}function Xt({handleTimeOut:i}){const s=r(t=>t.drillTime),o=r(t=>t.isDrillStarted),a=r(t=>t.decrementDrillTime);return m.useEffect(()=>{if(!o)return;if(s<1){i();return}const t=setInterval(()=>{a()},1e3);return()=>{clearInterval(t)}},[s]),e.jsx("p",{children:pt(s)})}const Yt="_DrillStartWrapper_1lv0v_1",qt={DrillStartWrapper:Yt};function ee(){const{prefs:i}=b(),s=r(l=>l.drillOptions),o=r(l=>l.setDrillTime),a=r(l=>l.setIsDrillStarted),t=r(l=>l.resetDrill),c=r(l=>l.setTimeSinceLastCorrectNote),d=L();if(m.useEffect(()=>{if(!s){d("/");return}t(),o(s.timer?s.timer:10),a(!0),c(Date.now()),i.midiPlaybackEnabled&&I.loadAllSamples()},[s]),!!s)return e.jsx("div",{className:qt.DrillStartWrapper,children:e.jsx("div",{className:"size-wrapper",children:e.jsx(Kt,{})})})}export{ee as default};
