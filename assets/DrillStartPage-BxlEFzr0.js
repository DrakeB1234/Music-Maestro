import{r as m,j as e,u as $}from"./react-DCaQfIlb.js";import{u as r,G as H,a as J,b as Q,c as x,N as G,B as y,S as Z,F as tt,P as M,d as I,M as et,T as nt,A as at,e as st,f as rt,g as ot,C as it,h as ct,i as lt,j as ut,k as dt,l as pt,m as L}from"./index-DWjw5bqu.js";import"./webmidi-DLahG6sQ.js";import"./vendor-p4PpBVHW.js";import"./vexflow-B_RgdgAq.js";const ft="_StaffContainer_1fdyi_1",mt={StaffContainer:ft};function Nt(){const o=r(t=>t.currentNote),a=r(t=>t.playedStatusNote),i=m.useRef(null),s=m.useRef(null);return m.useEffect(()=>{const t=r.getState().drillOptions;if(!(!i.current||!t))if(s.current)o&&s.current.drawNote(o);else{const c=t.octaveRange?.maxOctave,d=t.octaveRange?.minOctave,l=c?H(c,t.clef||"treble"):0,C=d?J(d,t.clef||"treble"):0,f=new Q(i.current,t.clef,void 0,void 0,l,C);if(!f)return;s.current=f}},[o]),m.useEffect(()=>{const t=r.getState().playedNote,c=r.getState().playedNoteStatus,d=r.getState().playedStatusNote;!d||!t||!o||c==="correct"||s.current?.drawWrongNote(o,d)},[a]),e.jsx("div",{className:mt.StaffContainer,ref:i})}const ht="_TopBarWrapper_1x8ji_1",Ct="_StatusBarContainer_1x8ji_33",St="_StatusBarError_1x8ji_41",xt="_StatusBarSuccess_1x8ji_49",vt="_CurrentNoteContainer_1x8ji_59",yt="_ButtonInputWrapper_1x8ji_103",_t="_PianoInput_1x8ji_119",jt="_MIDIInput_1x8ji_129",Bt="_MIDIInputDisconnectedContainer_1x8ji_139",N={TopBarWrapper:ht,StatusBarContainer:Ct,StatusBarError:St,StatusBarSuccess:xt,CurrentNoteContainer:vt,ButtonInputWrapper:yt,PianoInput:_t,MIDIInput:jt,MIDIInputDisconnectedContainer:Bt},It="_NoteButtonInputWrapper_ys8tc_1",Dt="_AccidentalButtonsContainer_ys8tc_15",gt="_NoteButtonsContainer_ys8tc_25",P={NoteButtonInputWrapper:It,AccidentalButtonsContainer:Dt,NoteButtonsContainer:gt};function At(){const o=m.useRef(null),a=x(t=>t.triggerButtonInput),i=t=>{const c={name:t,accidental:o.current,octave:null};a(c)},s=t=>{o.current=t};return e.jsxs("div",{className:P.NoteButtonInputWrapper,children:[e.jsx(Mt,{onAccidentalSet:s}),e.jsx("div",{className:P.NoteButtonsContainer,children:G.map(t=>e.jsx(y,{onClick:()=>i(t),variant:"outlined",size:"large",text:t},t))})]})}function Mt({onAccidentalSet:o}){const[a,i]=m.useState(null),s=t=>{if(t===a){i(null),o(null);return}o(t),i(t)};return e.jsxs("div",{className:P.AccidentalButtonsContainer,children:[e.jsx(y,{active:a==="#",onClick:()=>s("#"),variant:"outlined",icon:e.jsx(Z,{})}),e.jsx(y,{active:a==="b",onClick:()=>s("b"),variant:"outlined",icon:e.jsx(tt,{})})]})}const S="/Music-Maestro/",E=[{note:{name:"C",octave:1},url:`${S}piano_samples/C1.mp3`},{note:{name:"C",octave:2},url:`${S}piano_samples/C2.mp3`},{note:{name:"C",octave:3},url:`${S}piano_samples/C3.mp3`},{note:{name:"C",octave:4},url:`${S}piano_samples/C4.mp3`},{note:{name:"C",octave:5},url:`${S}piano_samples/C5.mp3`},{note:{name:"C",octave:6},url:`${S}piano_samples/C6.mp3`},{note:{name:"C",octave:7},url:`${S}piano_samples/C7.mp3`}],R=.5;class D{static audioContext;static pianoBuffers={};static masterGain;static audioPrefs={volume:50,playbackEnabled:!1};static playbackNoteLimit={min:{name:"C",octave:1},max:{name:"C",octave:8}};static init(){this.audioContext||(this.audioContext=new AudioContext),this.masterGain||(this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=R,this.masterGain.connect(this.audioContext.destination)),this.setVolume(this.audioPrefs.volume)}static async loadSample(a,i){if(this.pianoBuffers[a])return;const t=await(await fetch(i)).arrayBuffer(),c=await this.audioContext.decodeAudioData(t);this.pianoBuffers[a]=c}static async loadAllSamples(){this.init();const a=E.map(async i=>{await this.loadSample(M(i.note),i.url)});await Promise.all(a)}static determineSample(a){const s=E.map(t=>{const c=Math.abs(a-I(t.note));return{sample:t,semitoneOffset:a-I(t.note),absOffset:c}}).reduce((t,c)=>c.absOffset<t.absOffset?c:t);return{sample:M(s.sample.note),semitoneOffset:s.semitoneOffset}}static playNote(a,i=5){if(this.audioContext.state!=="running"&&this.audioContext.resume(),!this.audioPrefs.playbackEnabled)return;this.audioPrefs.volume&&this.setVolume(this.audioPrefs.volume);const s=I(a),t=I(this.playbackNoteLimit.min),c=I(this.playbackNoteLimit.max);if(s<t||s>c)return;const{sample:d,semitoneOffset:l}=this.determineSample(s),C=this.pianoBuffers[d];if(!C)return;const f=this.audioContext.createBufferSource();f.buffer=C,f.playbackRate.value=Math.pow(2,l/12);const h=this.audioContext.createGain();h.gain.setValueAtTime(1,this.audioContext.currentTime),h.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+i),f.connect(h),h.connect(this.masterGain),f.start(),f.stop(this.audioContext.currentTime+i),f.onended=()=>{f.disconnect(),h.disconnect()}}static playChord(a,i=5){!a||a.length===0||a.forEach(s=>{this.playNote(s,i)})}static setVolume(a){this.masterGain.gain.value=Math.max(0,R*(a/100))}static applyPreferences(a){D.audioPrefs=a}}const Pt="_ModalContentContainer_30uwr_1",bt="_ModalActionButtonsContainer_30uwr_17",Tt="_ContentWrapper_30uwr_31",Ot="_AccuracyContainer_30uwr_45",Wt="_ScoreContainer_30uwr_47",v={ModalContentContainer:Pt,ModalActionButtonsContainer:bt,ContentWrapper:Tt,AccuracyContainer:Ot,ScoreContainer:Wt};function kt({drillScore:o,correctNotesPlayed:a,totalNotesPlayed:i,handleDrillExit:s,handleDrillTryAgain:t}){const c=Math.ceil(a/i*100);return e.jsxs(et,{headerText:"Drill Over!",icon:e.jsx(nt,{}),overrideExitButtonPressed:s,children:[e.jsxs("div",{className:v.ModalContentContainer,children:[e.jsxs("div",{className:v.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Your Score"}),e.jsx("div",{className:v.ScoreContainer,children:e.jsx("p",{className:"large-heading",children:o})})]}),e.jsxs("div",{className:v.ContentWrapper,children:[e.jsx("h1",{className:"body",children:"Accuracy"}),e.jsxs("div",{className:v.AccuracyContainer,children:[e.jsx("p",{className:"heading-secondary",children:`Correct: ${a}/${i}`}),e.jsxs("p",{className:"heading-secondary",children:[isNaN(c)?0:c,"%"]})]})]})]}),e.jsxs("div",{className:v.ModalActionButtonsContainer,children:[e.jsx(y,{text:"Close",variant:"outlined",fullWidth:!0,onClick:s}),e.jsx(y,{text:"Try Again",fullWidth:!0,onClick:t})]})]})}const wt="_PianoRollWrapper_1w151_1",Et="_WhiteKey_1w151_15",Rt="_BlackKey_1w151_31",A={PianoRollWrapper:wt,WhiteKey:Et,BlackKey:Rt},$t=[15,36,76,96,116];function Gt(){const o=x(s=>s.triggerButtonInput);function a(s){const t=s.match(/^([A-G])([#b]?)/);return t?{noteName:t[1],noteAccidental:t[2]}:{letter:s,accidental:""}}const i=s=>{const c=s.target.getAttribute("id");if(c){const{noteName:d,noteAccidental:l}=a(c);if(!d)return;o({name:d,accidental:l||null,octave:null})}};return e.jsxs("svg",{width:"140",height:"80",fill:"none",viewBox:"0 0 140 80",onClick:i,className:A.PianoRollWrapper,children:[G.map((s,t)=>e.jsxs("g",{className:A.WhiteKey,id:s,children:[e.jsx("rect",{id:s,width:20,height:80,fill:"var(--color-surface-light-1)",x:20*t}),e.jsx("line",{x1:t*20+1,x2:t*20+1,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:0,id:s}),e.jsx("line",{x1:t*20+20,x2:t*20+20,y1:0,y2:80,stroke:"var(--color-surface-border-2)",strokeWidth:.5,id:s})]},s)),at.map((s,t)=>e.jsx("g",{className:A.BlackKey,id:s,children:e.jsx("rect",{id:s,width:9,height:70,fill:"#282828",stroke:"#000",strokeWidth:3,x:$t[t],y:-27})},s))]})}const Lt=150;function Kt(){const o=r(n=>n.setCurrentNote),a=r(n=>n.setPlayedNote),i=r(n=>n.setPlayedNoteStatus),s=r(n=>n.setTimeSinceLastCorrectNote),t=r(n=>n.setDrillScore),c=r(n=>n.setIsDrillStarted),d=r(n=>n.resetDrillOptions),l=r(n=>n.setDrillOptions),C=x(n=>n.setButtonInputListener),f=x(n=>n.addMidiListener),h=x(n=>n.removeMidiListener),{addResult:K}=st(),_=m.useRef(0),j=m.useRef(0),{openModal:V,setPreventClose:g,closeModal:b}=rt(),F=$();function T(){const n=r.getState().drillOptions;if(!n)return;const p=r.getState().currentNote;let u=null;n.inclusiveNotes&&n.inclusiveNotes?.length>1?u=ct(n.inclusiveNotes,p||null):n.octaveRange&&(u=lt(p||null,n.octaveRange,n.allowedAccidentals)),u&&o(u)}function U(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(a(n),u&&ut(n,u)){n.octave=u?.octave||null,k(u);return}n.octave=u?.octave||null,W(n)}function O(n){if(!r.getState().isDrillStarted)return;const u=r.getState().currentNote;if(a(n),u&&dt(n,u)){k(n);return}W(n)}function W(n){_.current+=1,i("wrong",n)}function k(n){T(),_.current+=1,j.current+=1,i("correct",n),z(),D.playNote(n)}function z(){const n=r.getState().timeSinceLastCorrectNote,p=Date.now(),u=p-n;s(p);let B=Math.round(Lt*Math.exp(-4e-4*u));B=Math.max(B,0),t(B)}function X(){const n=r.getState().drillScore,p=r.getState().drillOptions,u=p?.timer?p.timer:1,B=Math.round(j.current/u*60);p?.drillId&&K({id:p.drillId,correctNotes:j.current,totalNotes:_.current,score:n,correctNotesPerMinute:B}),c(!1),q()}function w(){g(!1),b(),d(),F("/")}function Y(){const n=r.getState().drillOptions;j.current=0,_.current=0,t(0),n&&l({...n}),g(!1),b()}const q=()=>{const n=r.getState().drillScore;g(!0),V(e.jsx(kt,{drillScore:n,correctNotesPlayed:j.current,totalNotesPlayed:_.current,handleDrillExit:w,handleDrillTryAgain:Y}))};return m.useEffect(()=>{C(n=>U(n))},[C]),m.useEffect(()=>(f(O),()=>{h(O)}),[f,h]),m.useEffect(()=>{T()},[]),e.jsxs("div",{className:N.NoteDrillWrapper,children:[e.jsx(ot,{onBack:w}),e.jsxs(it,{children:[e.jsxs("div",{className:N.TopBarWrapper,children:[e.jsx(Xt,{handleTimeOut:X}),e.jsx(zt,{})]}),e.jsx(Ft,{}),e.jsx(Nt,{}),e.jsx(Ut,{}),e.jsx(Vt,{})]})]})}function Vt(){const{prefs:o}=L(),a=o.inputType,{connectMidiDevice:i}=x(),s=x(t=>t.isMidiDeviceConnected);return a==="buttons"?e.jsx("div",{className:`${N.ButtonInputWrapper}`,children:e.jsx(At,{})}):a==="piano"?e.jsx("div",{className:`${N.ButtonInputWrapper} ${N.PianoInput}`,children:e.jsx(Gt,{})}):e.jsxs("div",{className:`${N.ButtonInputWrapper} ${N.MIDIInput}`,children:[s&&e.jsx("p",{children:"MIDI Device Connected"}),!s&&e.jsxs("div",{className:N.MIDIInputDisconnectedContainer,children:[e.jsx("p",{children:"MIDI Device Disconnected"}),e.jsx(y,{text:"Connect",variant:"outlined",onClick:i})]})]})}function Ft(){const o=r(i=>i.playedNoteStatus),a=o=="correct"?N.StatusBarSuccess:o=="wrong"?N.StatusBarError:"";return e.jsx("div",{className:`${N.StatusBarContainer} ${a}`})}function Ut(){const o=r(a=>a.currentNote);return e.jsx("p",{className:N.CurrentNoteContainer,children:o&&M(o)})}function zt(){const o=r(a=>a.drillScore);return e.jsx("p",{children:o})}function Xt({handleTimeOut:o}){const a=r(t=>t.drillTime),i=r(t=>t.isDrillStarted),s=r(t=>t.decrementDrillTime);return m.useEffect(()=>{if(!i)return;if(a<1){o();return}const t=setInterval(()=>{s()},1e3);return()=>{clearInterval(t)}},[a]),e.jsx("p",{children:pt(a)})}const Yt="_DrillStartWrapper_1lv0v_1",qt={DrillStartWrapper:Yt};function ee(){const{prefs:o}=L(),a=r(l=>l.drillOptions),i=r(l=>l.setDrillTime),s=r(l=>l.setIsDrillStarted),t=r(l=>l.resetDrill),c=r(l=>l.setTimeSinceLastCorrectNote),d=$();if(m.useEffect(()=>{if(!a){d("/");return}t(),i(a.timer?a.timer:10),s(!0),c(Date.now()),o.midiPlaybackEnabled&&o.midiPlaybackEnabled&&o.midiPlaybackVolume&&(D.applyPreferences({playbackEnabled:o.midiPlaybackEnabled,volume:o.midiPlaybackVolume}),D.loadAllSamples())},[a]),!!a)return e.jsx("div",{className:qt.DrillStartWrapper,children:e.jsx("div",{className:"size-wrapper",children:e.jsx(Kt,{})})})}export{ee as default};
